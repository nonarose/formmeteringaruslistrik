<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Form Monitoring MCCB/PDB</title>

<style>
  body{font-family:"Segoe UI",sans-serif;background:#0d3b66;margin:0;padding:0;color:#000}
  .container{max-width:600px;margin:40px auto;background:#f8f9fa;padding:25px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.2)}
  h2,h3{text-align:center;color:#0d3b66;margin-top:0}
  label{display:block;margin-top:12px;font-weight:600}
  input,select,textarea{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:5px;font-size:14px;box-sizing:border-box}
  textarea{resize:vertical}
  button{background:#0d3b66;color:#fff;border:none;padding:12px;margin-top:20px;width:100%;border-radius:6px;font-size:16px;cursor:pointer;transition:background .3s}
  button:hover{background:#145ea8}
  #status,#lokasiStatus{text-align:center;margin-top:10px;font-weight:bold}
  .hidden{display:none}
  img.preview{margin-top:10px;max-width:100%;border:1px solid #ccc;border-radius:5px}
  table{border-collapse:collapse;width:100%;margin-top:20px;font-size:13px}
  th,td{border:1px solid #ccc;padding:8px;text-align:center}
  th{background:#f0f0f0}
  .small{font-size:12px;color:#666}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginPage">
  <h2>Login Petugas</h2>
  <label>Nama Petugas:</label>
  <input type="text" id="loginPetugas" placeholder="Masukkan nama petugas" required>

  <label>Satuan Kerja:</label>
  <select id="satuanKerja" required>
    <option value="">-- Pilih Satuan Kerja --</option>
    <option>Stasiun Pucanggading</option>
    <option>Tx Baribis</option>
    <option>Tx Garung</option>
    <option>Tx Gantungan</option>
    <option>Tx Gn Depok</option>
    <option>Tx Gn Tugel</option>
    <option>Tx Gombel</option>
    <option>Tx Pager Gedog</option>
    <option>Tx Pucang Pendawa</option>
    <option>Tx Semanggi</option>
  </select>

  <button id="loginBtn">Masuk</button>
  <p class="small">Reverse geocoding otomatis hanya untuk watermark foto</p>
</div>

<!-- FORM -->
<div class="container hidden" id="formPage">
  <h2>Form Monitoring Arus</h2>
  <p id="lokasiStatus">üìç Mengambil alamat...</p>

  <form id="meteringForm" onsubmit="return false;">
    <label>Nama Petugas:</label>
    <input type="text" id="petugas" readonly>

    <label>Satuan Kerja:</label>
    <input type="text" id="unitKerja" readonly>

    <label>Tanggal:</label>
    <input type="date" id="tanggal" required>

    <label>Shift:</label>
    <select id="shift" required>
      <option value="">-- Pilih Shift --</option>
      <option>Shift 1</option>
      <option>Shift 2</option>
      <option>Shift 3</option>
    </select>

    <label>MCCB/PDB:</label>
    <select id="mccb" required></select>

    <label>Arus R (A):</label>
    <input type="number" id="arus_r" required>

    <label>Arus S (A):</label>
    <input type="number" id="arus_s" required>

    <label>Arus T (A):</label>
    <input type="number" id="arus_t" required>

    <label>Catatan:</label>
    <textarea id="catatan" rows="3"></textarea>

    <button type="button" id="saveBtn">üíæ Simpan Data</button>
    <button type="button" id="fotoBtn" disabled>üì∏ Ambil Foto (1x / shift)</button>
    <button type="button" id="submitBtn">üì§ Kirim</button>
  </form>

  <p id="status"></p>

  <canvas id="canvas" class="hidden"></canvas>
  <img id="preview" class="preview hidden">

  <div id="output"></div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbx-nUXLPfa0l6U1QEnxRt61zPgM_rTcIvOnA0_XsbgBV_HiIylc1v0aNVXlTQI7jHfe/exec"; 

const loginPage = document.getElementById('loginPage');
const formPage = document.getElementById('formPage');
const satuanKerja = document.getElementById('satuanKerja');
const petugasInput = document.getElementById('petugas');
const unitKerjaInput = document.getElementById('unitKerja');

const tanggal = document.getElementById('tanggal');
const shift = document.getElementById('shift');
const arus_r = document.getElementById('arus_r');
const arus_s = document.getElementById('arus_s');
const arus_t = document.getElementById('arus_t');
const catatan = document.getElementById('catatan');

const mccbSelect = document.getElementById('mccb');
const lokasiStatus = document.getElementById('lokasiStatus');
const status = document.getElementById('status');

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const preview = document.getElementById('preview');
const fotoBtn = document.getElementById('fotoBtn');
const output = document.getElementById('output');

let lokasiTeks = { alamat:"", lat:"", lng:"" };
let savedReports = {};
let photoStore = {};

document.getElementById('loginBtn').onclick = () => {
  const nama = document.getElementById('loginPetugas').value.trim();
  const unit = satuanKerja.value;
  if (!nama || !unit) return alert("Isi semua field!");

  petugasInput.value = nama;
  unitKerjaInput.value = unit;

  loginPage.classList.add('hidden');
  formPage.classList.remove('hidden');

  ambilLokasi();
  isiDropdown(unit);
};

function isiDropdown(u){
  mccbSelect.innerHTML = `<option value="">--Pilih--</option>`;
  let list =
    u === "Stasiun Pucanggading"
      ? [
          "MCCB GPO/Administrasi","MCCB Peralatan G. Ops.","MCCB Pen. Lantai 2 G. Ops.",
          "MCCB AC Lantai 2 G. Ops.","MCCB AC Studio Utama",
          "MCCB AC R. Berita / Siaran Lantai 2, G.Ops.",
          "MCCB Studio 2 dan AC Teknik","MCCB Lap. Tenis/AC R. Redaksi G. Ops.",
          "MCCB AC Lantai 1 G. Ops.","MCCB Dimer/Lighting Sto. 1","MCCB Outdoor/L. Taman"
        ]
      : ["PDB Pemancar","PDB AC","PDB Penerangan"];

  list.forEach(x => mccbSelect.insertAdjacentHTML("beforeend", `<option>${x}</option>`));
}

function ambilLokasi(){
  lokasiStatus.innerText="üìçMengambil...";
  navigator.geolocation?.getCurrentPosition(async p=>{
    const lat=p.coords.latitude.toFixed(6);
    const lng=p.coords.longitude.toFixed(6);
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
      const j=await r.json();
      lokasiTeks={alamat:j.display_name,lat,lng};
      lokasiStatus.innerText="‚úÖ "+j.display_name;
    }catch{
      lokasiTeks={alamat:`${lat}, ${lng}`,lat,lng};
      lokasiStatus.innerText="‚ö†Ô∏è Lokasi diperoleh";
    }
  });
}

document.getElementById('saveBtn').onclick = ()=>{
  if(!mccbSelect.value) return alert("Pilih MCCB terlebih dahulu!");

  savedReports[mccbSelect.value] = {
    petugas: petugasInput.value,
    unit: unitKerjaInput.value,
    tanggal: tanggal.value,
    shift: shift.value,
    arus_r: arus_r.value,
    arus_s: arus_s.value,
    arus_t: arus_t.value,
    catatan: catatan.value,
    savedAt: new Date().toLocaleString()
  };

  fotoBtn.disabled=false;
  status.innerText="‚úÖ Data tersimpan";
  render();
};

fotoBtn.onclick=()=>{
  let i=document.createElement('input');
  i.type='file'; i.accept='image/*'; i.capture='environment';

  i.onchange=e=>{
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      let img=new Image();
      img.src=ev.target.result;
      img.onload=()=>{
        const w=1600,h=img.height*(1600/img.width);
        canvas.width=w; canvas.height=h;
        ctx.drawImage(img,0,0,w,h);
        addWatermark();
        const key=`${unitKerjaInput.value}|${tanggal.value}|${shift.value}`;
        photoStore[key] = canvas.toDataURL('image/jpeg',0.7);
        preview.src=photoStore[key];
        preview.classList.remove('hidden');
      };
    };
    reader.readAsDataURL(file);
  };

  i.click();
};

function addWatermark(){
  ctx.fillStyle="rgba(0,0,0,.5)";
  ctx.fillRect(0,canvas.height-80,canvas.width,80);
  ctx.fillStyle="#fff";
  ctx.font="bold 14px Segoe UI";
  ctx.fillText("üìç "+lokasiTeks.alamat,10,canvas.height-60);
  ctx.fillText(`${petugasInput.value} ‚Äî ${unitKerjaInput.value}`,10,canvas.height-40);
  ctx.fillText(new Date().toLocaleString(),10,canvas.height-20);
}

function render(){
  let html = `<h3>Data Tersimpan</h3><table><tr>
    <th>MCCB/PDB</th><th>R</th><th>S</th><th>T</th><th>Catatan</th></tr>`;

  for(let k in savedReports){
    let d=savedReports[k];
    html += `<tr>
      <td>${k}</td><td>${d.arus_r}</td><td>${d.arus_s}</td><td>${d.arus_t}</td><td>${d.catatan}</td>
    </tr>`;
  }
  html+="</table>";
  output.innerHTML=html;
}

document.getElementById('submitBtn').onclick=async()=>{
  if(!Object.keys(savedReports).length)
    return alert("Belum ada data tersimpan!");

  status.innerText="‚è≥ Mengirim ke server...";
  
  const any = Object.values(savedReports)[0];
  const keyPhot = `${any.unit}|${any.tanggal}|${any.shift}`;
  
  const payload = {
    entries: savedReports,
    _photos: {}
  };

  if(photoStore[keyPhot])
    payload._photos[keyPhot] = photoStore[keyPhot];

  const res = await fetch(scriptURL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  status.innerText = await res.text();
};
</script>

</body>
</html>

